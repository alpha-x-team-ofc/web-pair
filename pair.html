<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DTZ NOVA - WhatsApp Pair</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, 
                rgba(26, 26, 26, 0.9) 0%, 
                rgba(10, 10, 10, 0.9) 100%),
                url('https://files.catbox.moe/fpyw9m.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: #fff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            background: rgba(30, 30, 30, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 45, 45, 0.3);
            position: relative;
            z-index: 1;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 20px;
            z-index: -1;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo {
            font-size: 24px;
            color: #ff2d2d;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(255, 45, 45, 0.5);
        }
        
        .title {
            font-size: 28px;
            background: linear-gradient(90deg, #ff2d2d, #ff6a00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #aaa;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .input-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            color: #ff6a00;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }
        
        input {
            width: 100%;
            padding: 15px;
            background: rgba(10, 10, 10, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #fff;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #ff2d2d;
            box-shadow: 0 0 15px rgba(255, 45, 45, 0.3);
        }
        
        .hint {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            margin-left: 5px;
        }
        
        .btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #ff2d2d, #ff6a00);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 45, 45, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }
        
        .btn:hover::after {
            left: 100%;
        }
        
        .result {
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(5px);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-title {
            color: #ff6a00;
            margin-bottom: 10px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .result-content {
            color: #fff;
            font-family: 'Courier New', monospace;
            word-break: break-all;
        }
        
        .code {
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 24px;
            text-align: center;
            letter-spacing: 5px;
            border: 1px solid rgba(255, 45, 45, 0.3);
            font-weight: bold;
        }
        
        .instructions {
            background: rgba(255, 152, 0, 0.15);
            border: 1px solid rgba(255, 152, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 14px;
            color: #ff9800;
        }
        
        .instructions ol {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #aaa;
            font-size: 12px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #ff2d2d;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(255, 45, 45, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 45, 45, 0.8); }
        }
        
        .glow {
            animation: glow 2s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">‚ñ∂ ‚óè‚îÄ‚îÄ‚îÄ·¥Ö·¥õ·¥¢ …¥·¥è·¥†·¥Ä x·¥ç·¥Ö‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂ ‚óè</div>
            <div class="title">WhatsApp Pairing</div>
            <div class="subtitle">Connect your WhatsApp account to DTZ NOVA XMD</div>
            <div class="subtitle" id="status" style="color: #4CAF50; margin-top: 10px;">
                <span id="serverStatus">Checking server...</span>
            </div>
        </div>
        
        <div class="input-group">
            <label for="number"><i class="fas fa-phone"></i> WhatsApp Number</label>
            <input 
                type="tel" 
                id="number" 
                placeholder="94712345678 (with country code)"
                maxlength="15"
                oninput="this.value = this.value.replace(/\D/g, '')"
            >
            <div class="hint">Enter your WhatsApp number without + sign</div>
        </div>
        
        <button class="btn" onclick="startPairing()" id="pairBtn">
            <span id="btnText">Generate Pairing Code</span>
            <span id="btnLoading" style="display: none;" class="loading"></span>
        </button>
        
        <div class="result" id="result">
            <div class="result-title" id="resultTitle">
                <span id="resultIcon">üì±</span>
                <span id="resultText">Pairing Code</span>
            </div>
            <div class="result-content" id="resultContent">
                <div class="code" id="pairingCode">000000</div>
                <div class="instructions" id="instructions">
                    <strong>How to use:</strong>
                    <ol>
                        <li>Open WhatsApp on your phone</li>
                        <li>Go to Settings ‚Üí Linked Devices</li>
                        <li>Tap "Link a Device"</li>
                        <li>Enter the 6-digit code above</li>
                        <li>Wait for confirmation on WhatsApp</li>
                    </ol>
                    <div style="margin-top: 10px; font-size: 12px;">
                        <i class="fas fa-clock"></i> Code valid for 10 minutes
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <div>üë§ Owner: Dulina | ‚ö° Team: DTZ TEAM</div>
            <div style="margin-top: 5px;">Version 3.0 - Simple & Working</div>
        </div>
    </div>
    
    <script>
        // Check server status
        async function checkServer() {
            try {
                const res = await fetch('/health');
                if (res.ok) {
                    document.getElementById('serverStatus').innerHTML = 
                        'üü¢ Server Online | ' + new Date().toLocaleTimeString();
                    document.getElementById('serverStatus').style.color = '#4CAF50';
                    return true;
                }
            } catch (error) {
                document.getElementById('serverStatus').innerHTML = 
                    'üî¥ Server Offline';
                document.getElementById('serverStatus').style.color = '#ff4444';
            }
            return false;
        }
        
        // Start pairing process
        async function startPairing() {
            const number = document.getElementById('number').value.trim();
            
            // Validate
            if (!number || number.length < 10) {
                alert('Please enter a valid WhatsApp number (at least 10 digits)');
                document.getElementById('number').focus();
                return;
            }
            
            // Disable button and show loading
            const btn = document.getElementById('pairBtn');
            const btnText = document.getElementById('btnText');
            const btnLoading = document.getElementById('btnLoading');
            
            btn.disabled = true;
            btnText.textContent = 'Generating...';
            btnLoading.style.display = 'inline-block';
            
            // Hide previous result
            document.getElementById('result').style.display = 'none';
            
            try {
                // Call pairing endpoint
                const response = await fetch('/pair/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ number })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to generate pairing code');
                }
                
                // Show success result
                showResult('success', data.pairingCode, data);
                
                // Start monitoring session
                if (data.sessionId) {
                    monitorSession(data.sessionId);
                }
                
            } catch (error) {
                console.error('Error:', error);
                showResult('error', null, {
                    error: error.message,
                    message: 'Failed to generate pairing code'
                });
            } finally {
                // Re-enable button
                btn.disabled = false;
                btnText.textContent = 'Generate Pairing Code';
                btnLoading.style.display = 'none';
            }
        }
        
        // Show result
        function showResult(type, code, data) {
            const result = document.getElementById('result');
            const resultIcon = document.getElementById('resultIcon');
            const resultText = document.getElementById('resultText');
            const resultContent = document.getElementById('resultContent');
            const pairingCodeEl = document.getElementById('pairingCode');
            const instructions = document.getElementById('instructions');
            
            result.style.display = 'block';
            
            if (type === 'success' && code) {
                // Success with pairing code
                resultIcon.textContent = '‚úÖ';
                resultIcon.style.color = '#4CAF50';
                resultText.textContent = 'Pairing Code Generated';
                resultText.style.color = '#4CAF50';
                
                pairingCodeEl.textContent = code;
                pairingCodeEl.className = 'code pulse glow';
                pairingCodeEl.style.display = 'block';
                
                instructions.style.display = 'block';
                instructions.innerHTML = `
                    <strong>How to use:</strong>
                    <ol>
                        <li>Open WhatsApp on your phone</li>
                        <li>Go to Settings ‚Üí Linked Devices</li>
                        <li>Tap "Link a Device"</li>
                        <li>Enter this code: <strong>${code}</strong></li>
                        <li>Wait for confirmation message</li>
                    </ol>
                    <div style="margin-top: 10px; font-size: 12px;">
                        <i class="fas fa-clock"></i> Code valid for 10 minutes<br>
                        <i class="fas fa-id-card"></i> Session ID: ${data.sessionId || 'N/A'}
                    </div>
                `;
                
                // Add copy button
                if (!document.getElementById('copyBtn')) {
                    const copyBtn = document.createElement('button');
                    copyBtn.id = 'copyBtn';
                    copyBtn.className = 'btn';
                    copyBtn.style.marginTop = '10px';
                    copyBtn.style.background = '#2196F3';
                    copyBtn.innerHTML = 'üìã Copy Code';
                    copyBtn.onclick = () => copyCode(code);
                    resultContent.appendChild(copyBtn);
                }
                
            } else {
                // Error
                resultIcon.textContent = '‚ùå';
                resultIcon.style.color = '#ff4444';
                resultText.textContent = 'Error';
                resultText.style.color = '#ff4444';
                
                pairingCodeEl.style.display = 'none';
                instructions.style.display = 'block';
                instructions.style.background = 'rgba(255, 68, 68, 0.15)';
                instructions.style.borderColor = 'rgba(255, 68, 68, 0.3)';
                instructions.style.color = '#ff4444';
                instructions.innerHTML = `
                    <strong>Error Details:</strong><br>
                    ${data.error || data.message || 'Unknown error'}<br><br>
                    <strong>Possible solutions:</strong>
                    <ol>
                        <li>Check if number has WhatsApp</li>
                        <li>Ensure correct country code</li>
                        <li>Try again in 1 minute</li>
                        <li>Contact support if persists</li>
                    </ol>
                `;
            }
        }
        
        // Copy code to clipboard
        function copyCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                const copyBtn = document.getElementById('copyBtn');
                if (copyBtn) {
                    copyBtn.innerHTML = '‚úÖ Copied!';
                    copyBtn.style.background = '#4CAF50';
                    setTimeout(() => {
                        copyBtn.innerHTML = 'üìã Copy Code';
                        copyBtn.style.background = '#2196F3';
                    }, 2000);
                }
            }).catch(err => {
                console.error('Copy failed:', err);
            });
        }
        
        // Monitor session status
        async function monitorSession(sessionId) {
            if (!sessionId) return;
            
            const checkStatus = async () => {
                try {
                    const res = await fetch(`/pair/status/${sessionId}`);
                    const data = await res.json();
                    
                    if (data.status === 'active' && data.connected) {
                        // Session is connected
                        const instructions = document.getElementById('instructions');
                        instructions.innerHTML = `
                            <div style="color: #4CAF50;">
                                ‚úÖ <strong>Connected Successfully!</strong><br>
                                Session has been created and sent to your WhatsApp.
                            </div>
                            <div style="margin-top: 10px; font-size: 12px;">
                                <i class="fas fa-check-circle"></i> Check your WhatsApp for session details
                            </div>
                        `;
                        
                        // Update pairing code display
                        const pairingCodeEl = document.getElementById('pairingCode');
                        pairingCodeEl.className = 'code';
                        pairingCodeEl.style.animation = 'none';
                        pairingCodeEl.style.borderColor = '#4CAF50';
                        
                        return true;
                    }
                    
                    return false;
                } catch (error) {
                    return false;
                }
            };
            
            // Check every 5 seconds for 2 minutes
            let attempts = 0;
            const maxAttempts = 24; // 2 minutes
            const interval = setInterval(async () => {
                attempts++;
                
                const connected = await checkStatus();
                if (connected || attempts >= maxAttempts) {
                    clearInterval(interval);
                    
                    if (!connected) {
                        const instructions = document.getElementById('instructions');
                        instructions.innerHTML += `
                            <div style="color: #ff9800; margin-top: 10px;">
                                ‚è±Ô∏è Monitoring stopped (2 minutes elapsed)
                            </div>
                        `;
                    }
                }
            }, 5000);
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Check server status
            checkServer();
            setInterval(checkServer, 30000);
            
            // Enter key support
            document.getElementById('number').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    startPairing();
                }
            });
            
            // Auto-focus input
            document.getElementById('number').focus();
            
            // Add subtle background animation
            document.body.style.animation = 'fadeIn 1s ease-out';
        });
    </script>
</body>
</html>
